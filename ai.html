<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart-StockFlow - Advanced AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 16px;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .ai-response {
            border-left: 4px solid #667eea;
            background-color: #f8fafc;
        }
        
        .example-query {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .example-query:hover {
            background-color: #ebf4ff;
            transform: translateX(5px);
        }
        
        .feature-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 28px;
        }
        
        .ai-thinking {
            display: flex;
            align-items: center;
            color: #6b7280;
        }
        
        .dot-flashing {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #3b82f6;
            color: #3b82f6;
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: 0.5s;
            margin: 0 5px;
        }
        
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #3b82f6;
            color: #3b82f6;
        }
        
        .dot-flashing::before {
            left: -15px;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }
        
        .dot-flashing::after {
            left: 15px;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }
        
        @keyframes dotFlashing {
            0% {
                background-color: #3b82f6;
            }
            50%, 100% {
                background-color: #dbeafe;
            }
        }
        
        .suggestion-chip {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .suggestion-chip:hover {
            background-color: #3b82f6;
            color: white;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        
        .insight-card {
            border-left: 4px solid #10b981;
            transition: all 0.3s ease;
        }
        
        .insight-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .warning-card {
            border-left: 4px solid #f59e0b;
        }
        
        .alert-card {
            border-left: 4px solid #ef4444;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">StockFlow AI Assistant</h1>
            <p class="text-gray-600">Your intelligent inventory management companion</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - AI Chat Interface -->
            <div class="lg:col-span-2">
                <div class="card bg-white overflow-hidden">
                    <div class="gradient-bg px-6 py-4 text-white">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full bg-white bg-opacity-20 flex items-center justify-center text-white mr-4">
                                <i class="fas fa-robot text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-semibold">AI Inventory Assistant</h2>
                                <p class="text-blue-100">Ask me anything about your inventory</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-6">
                            <div class="flex">
                                <input type="text" id="aiQuery" placeholder="Ask something like 'What items should I reorder?'" class="flex-1 border border-gray-300 rounded-l-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <button id="askAI" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-r-lg font-medium">
                                    <i class="fas fa-paper-plane mr-2"></i> Ask
                                </button>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="font-medium text-gray-700 mb-3">Try asking:</h3>
                            <div class="flex flex-wrap gap-2">
                                <div class="suggestion-chip bg-gray-100 text-gray-800 px-4 py-2 rounded-full text-sm" data-query="What items need reordering?">
                                    Reorder suggestions
                                </div>
                                <div class="suggestion-chip bg-gray-100 text-gray-800 px-4 py-2 rounded-full text-sm" data-query="Show me items expiring soon">
                                    Expiring soon
                                </div>
                                <div class="suggestion-chip bg-gray-100 text-gray-800 px-4 py-2 rounded-full text-sm" data-query="Which department uses the most supplies?">
                                    Department usage
                                </div>
                                <div class="suggestion-chip bg-gray-100 text-gray-800 px-4 py-2 rounded-full text-sm" data-query="Generate inventory report">
                                    Inventory report
                                </div>
                            </div>
                        </div>

                        <div id="thinkingIndicator" class="ai-thinking hidden p-5 rounded-lg mb-4 bg-blue-50">
                            <div class="dot-flashing"></div>
                            <span class="ml-2">Analyzing your inventory data...</span>
                        </div>

                        <div id="aiResponse" class="ai-response p-5 rounded-lg mb-4">
                            <p class="text-gray-500">I'm ready to help you manage your inventory. Ask me anything about your stock levels, trends, or for recommendations.</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="insight-card bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center mb-2">
                            <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600 mr-2">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3 class="font-semibold">Inventory Value</h3>
                        </div>
                        <p class="text-gray-600 text-sm" id="totalValueInsight">Calculating...</p>
                    </div>
                    
                    <div class="warning-card bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center mb-2">
                            <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 mr-2">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3 class="font-semibold">Low Stock Items</h3>
                        </div>
                        <p class="text-gray-600 text-sm" id="lowStockInsight">Calculating...</p>
                    </div>
                </div>
            </div>
            
            <!-- Right Column - AI Features and Insights -->
            <div class="space-y-6">
                <div class="card bg-white p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">AI Insights</h2>
                    
                    <div class="alert-card bg-white p-4 rounded-lg shadow mb-4">
                        <div class="flex items-center mb-2">
                            <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600 mr-2">
                                <i class="fas fa-clock"></i>
                            </div>
                            <h3 class="font-semibold">Expiration Alerts</h3>
                        </div>
                        <p class="text-gray-600 text-sm" id="expiryInsight">Calculating...</p>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-medium text-gray-700 mb-2">Category Distribution</h3>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium text-gray-700 mb-2">Stock Health</h3>
                        <div class="chart-container">
                            <canvas id="stockHealthChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card bg-white p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">AI Capabilities</h2>
                    
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 mr-3 flex-shrink-0">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div>
                                <h3 class="font-medium">Predictive Analysis</h3>
                                <p class="text-gray-600 text-sm">Forecast inventory needs based on usage patterns</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 mr-3 flex-shrink-0">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div>
                                <h3 class="font-medium">Trend Identification</h3>
                                <p class="text-gray-600 text-sm">Spot usage trends and seasonal patterns</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 mr-3 flex-shrink-0">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div>
                                <h3 class="font-medium">Smart Recommendations</h3>
                                <p class="text-gray-600 text-sm">Get data-driven ordering suggestions</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize sample data if not exists
        function initializeStorage() {
            if (!localStorage.getItem('inventory')) {
                const sampleInventory = [
                    { id: 1, code: "PEN-BL", name: "Blue Pens", category: "Stationery", price: 10.00, quantity: 8, reorderLevel: 20, expiryDate: null, dailyUsage: 5 },
                    { id: 2, code: "PEN-BK", name: "Black Pens", category: "Stationery", price: 10.00, quantity: 50, reorderLevel: 20, expiryDate: null, dailyUsage: 8 },
                    { id: 3, code: "NOTE-A4", name: "A4 Notebooks", category: "Stationery", price: 150.00, quantity: 15, reorderLevel: 30, expiryDate: null, dailyUsage: 10 },
                    { id: 4, code: "BUN-SCI", name: "Science Bunsen Burner", category: "Lab Equipment", price: 2500.00, quantity: 15, reorderLevel: 5, expiryDate: null, dailyUsage: 0.2 },
                    { id: 5, code: "CLN-SP", name: "Surface Cleaner", category: "Cleaning Supplies", price: 450.00, quantity: 5, reorderLevel: 10, expiryDate: "2023-12-15", dailyUsage: 1 },
                    { id: 6, code: "CAL-SCI", name: "Scientific Calculator", category: "Electronics", price: 1200.00, quantity: 40, reorderLevel: 10, expiryDate: null, dailyUsage: 0.5 },
                    { id: 7, code: "DESK-ST", name: "Student Desk", category: "Furniture", price: 3500.00, quantity: 60, reorderLevel: 10, expiryDate: null, dailyUsage: 0.1 },
                    { id: 8, code: "BBALL-OF", name: "Official Basketball", category: "Sports Equipment", price: 2800.00, quantity: 3, reorderLevel: 5, expiryDate: null, dailyUsage: 0.3 }
                ];
                localStorage.setItem('inventory', JSON.stringify(sampleInventory));
            }

            if (!localStorage.getItem('transactions')) {
                const sampleTransactions = [
                    { id: 1, itemId: 1, type: "receive", quantity: 50, date: "2023-09-01", department: "Store", reference: "REC-001", notes: "Initial stock" },
                    { id: 2, itemId: 2, type: "receive", quantity: 30, date: "2023-09-01", department: "Store", reference: "REC-002", notes: "Initial stock" },
                    { id: 3, itemId: 1, type: "issue", quantity: 10, date: "2023-09-05", department: "Admin", reference: "ISS-001", notes: "For office use" },
                    { id: 4, itemId: 2, type: "issue", quantity: 15, date: "2023-09-05", department: "Library", reference: "ISS-002", notes: "For library use" },
                    { id: 5, itemId: 3, type: "receive", quantity: 100, date: "2023-09-10", department: "Store", reference: "REC-003", notes: "New shipment" },
                    { id: 6, itemId: 5, type: "issue", quantity: 5, date: "2023-09-12", department: "Science", reference: "ISS-003", notes: "Lab cleaning" },
                    { id: 7, itemId: 4, type: "issue", quantity: 2, date: "2023-09-15", department: "Science", reference: "ISS-004", notes: "Physics lab" },
                    { id: 8, itemId: 6, type: "issue", quantity: 3, date: "2023-09-15", department: "Math", reference: "ISS-005", notes: "Math competition" },
                    { id: 9, itemId: 8, type: "issue", quantity: 2, date: "2023-09-18", department: "Sports", reference: "ISS-006", notes: "Basketball practice" },
                    { id: 10, itemId: 7, type: "issue", quantity: 5, date: "2023-09-20", department: "Admin", reference: "ISS-007", notes: "New staff offices" }
                ];
                localStorage.setItem('transactions', JSON.stringify(sampleTransactions));
            }

            if (!localStorage.getItem('departments')) {
                const sampleDepartments = ["Administration", "Science", "Mathematics", "Humanities", "Sports", "Library", "Store"];
                localStorage.setItem('departments', JSON.stringify(sampleDepartments));
            }
        }

        // DOM Elements
        const aiQuery = document.getElementById('aiQuery');
        const askAI = document.getElementById('askAI');
        const aiResponse = document.getElementById('aiResponse');
        const thinkingIndicator = document.getElementById('thinkingIndicator');
        const suggestionChips = document.querySelectorAll('.suggestion-chip');
        const totalValueInsight = document.getElementById('totalValueInsight');
        const lowStockInsight = document.getElementById('lowStockInsight');
        const expiryInsight = document.getElementById('expiryInsight');

        // Chart instances
        let categoryChartInstance = null;
        let stockHealthChartInstance = null;

        // Initialize the application
        initializeStorage();
        updateInsights();
        initCharts();

        // Event Listeners
        askAI.addEventListener('click', function() {
            const query = aiQuery.value.trim();
            if (query) {
                processAIQuery(query);
            }
        });

        aiQuery.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = aiQuery.value.trim();
                if (query) {
                    processAIQuery(query);
                }
            }
        });

        suggestionChips.forEach(chip => {
            chip.addEventListener('click', function() {
                const query = this.getAttribute('data-query');
                aiQuery.value = query;
                processAIQuery(query);
            });
        });

        // Initialize Charts
        function initCharts() {
            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
            
            // Category Distribution Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            const categories = [...new Set(inventory.map(item => item.category))];
            const categoryCounts = categories.map(category => 
                inventory.filter(item => item.category === category).length
            );
            
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }
            
            categoryChartInstance = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: categoryCounts,
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', 
                            '#ef4444', '#ec4899', '#06b6d4'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // Stock Health Chart
            const stockHealthCtx = document.getElementById('stockHealthChart').getContext('2d');
            const lowStockCount = inventory.filter(item => item.quantity <= item.reorderLevel).length;
            const adequateStockCount = inventory.filter(item => item.quantity > item.reorderLevel && item.quantity <= item.reorderLevel * 2).length;
            const goodStockCount = inventory.filter(item => item.quantity > item.reorderLevel * 2).length;
            
            if (stockHealthChartInstance) {
                stockHealthChartInstance.destroy();
            }
            
            stockHealthChartInstance = new Chart(stockHealthCtx, {
                type: 'bar',
                data: {
                    labels: ['Low Stock', 'Adequate Stock', 'Good Stock'],
                    datasets: [{
                        data: [lowStockCount, adequateStockCount, goodStockCount],
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#10b981'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // Update Insights
        function updateInsights() {
            const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            
            // Total Value Insight
            const totalValue = inventory.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            totalValueInsight.textContent = `Total inventory value: Ksh${totalValue.toLocaleString()}`;
            
            // Low Stock Insight
            const lowStockItems = inventory.filter(item => item.quantity <= item.reorderLevel);
            lowStockInsight.textContent = `${lowStockItems.length} items need reordering`;
            
            // Expiry Insight
            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setDate(today.getDate() + 30);
            
            const expiringItems = inventory.filter(item => {
                if (!item.expiryDate) return false;
                const expiryDate = new Date(item.expiryDate);
                return expiryDate <= nextMonth && expiryDate >= today;
            });
            
            expiryInsight.textContent = `${expiringItems.length} items expiring in the next 30 days`;
        }

        // AI Processing Function
        function processAIQuery(query) {
            // Show thinking indicator
            thinkingIndicator.classList.remove('hidden');
            aiResponse.classList.add('hidden');
            
            // Simulate AI processing time
            setTimeout(() => {
                const inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                
                let response = analyzeQuery(query, inventory, transactions);
                
                // Hide thinking indicator and show response
                thinkingIndicator.classList.add('hidden');
                aiResponse.classList.remove('hidden');
                aiResponse.innerHTML = response;
                
                // Update insights and charts
                updateInsights();
                initCharts();
            }, 1500);
        }

        // AI Analysis Function
        function analyzeQuery(query, inventory, transactions) {
            const lowerQuery = query.toLowerCase();
            
            // Low stock analysis
            if (lowerQuery.includes('low stock') || lowerQuery.includes('reorder') || 
                lowerQuery.includes('running out') || lowerQuery.includes('need to order')) {
                return analyzeLowStock(inventory);
            }
            
            // Expiry analysis
            if (lowerQuery.includes('expir') || lowerQuery.includes('expiring') || 
                lowerQuery.includes('going bad') || lowerQuery.includes('spoilage')) {
                return analyzeExpiringItems(inventory);
            }
            
            // Department usage analysis
            if (lowerQuery.includes('department') || lowerQuery.includes('usage') || 
                lowerQuery.includes('which department') || lowerQuery.includes('most used')) {
                return analyzeDepartmentUsage(transactions, inventory);
            }
            
            // Value analysis
            if (lowerQuery.includes('value') || lowerQuery.includes('worth') || 
                lowerQuery.includes('total value') || lowerQuery.includes('inventory value')) {
                return analyzeInventoryValue(inventory);
            }
            
            // Category analysis
            if (lowerQuery.includes('category') || lowerQuery.includes('categories') || 
                lowerQuery.includes('type') || lowerQuery.includes('kinds')) {
                return analyzeCategories(inventory);
            }
            
            // Forecast analysis
            if (lowerQuery.includes('forecast') || lowerQuery.includes('prediction') || 
                lowerQuery.includes('will run out') || lowerQuery.includes('when')) {
                return analyzeForecast(inventory);
            }
            
            // Report generation
            if (lowerQuery.includes('report') || lowerQuery.includes('summary') || 
                lowerQuery.includes('overview') || lowerQuery.includes('generate')) {
                return generateInventoryReport(inventory, transactions);
            }
            
            // General inventory overview
            if (lowerQuery.includes('how many') || lowerQuery.includes('what do we have') ||
                lowerQuery.includes('show me') || lowerQuery.includes('list')) {
                return provideInventoryOverview(inventory);
            }
            
            // Default response for unrecognized queries
            return "<p class='text-gray-800'>I'm not sure how to respond to that. Try asking about low stock items, expiring products, department usage, inventory value, or request a general overview of your inventory.</p>";
        }

        // Analysis Functions
        function analyzeLowStock(inventory) {
            const lowStockItems = inventory.filter(item => item.quantity <= item.reorderLevel);
            
            if (lowStockItems.length === 0) {
                return `<p class="text-green-600 font-medium">Great news! All items are currently well stocked above their reorder levels. No need to place any urgent orders at this time.</p>`;
            }
            
            let response = `<p class="text-gray-800 mb-3">I found <span class="font-semibold">${lowStockItems.length} item(s)</span> that are low in stock and need reordering:</p><ul class="mt-2 ml-5 list-disc">`;
            
            lowStockItems.forEach(item => {
                response += `<li class="mb-2"><span class="font-semibold">${item.name}</span> - Only ${item.quantity} left (reorder level: ${item.reorderLevel})</li>`;
            });
            
            response += `</ul><p class="mt-3 text-gray-800">I recommend placing orders for these items soon to avoid stockouts. Based on usage patterns, you should order at least ${Math.max(...lowStockItems.map(item => item.reorderLevel * 2 - item.quantity))} units of each to maintain adequate stock levels.</p>`;
            
            return response;
        }

        function analyzeExpiringItems(inventory) {
            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setDate(today.getDate() + 30);
            
            const expiringItems = inventory.filter(item => {
                if (!item.expiryDate) return false;
                const expiryDate = new Date(item.expiryDate);
                return expiryDate <= nextMonth && expiryDate >= today;
            });
            
            if (expiringItems.length === 0) {
                return `<p class="text-green-600 font-medium">No items are expiring in the next 30 days. Your inventory is in good condition!</p>`;
            }
            
            let response = `<p class="text-gray-800 mb-3">I found <span class="font-semibold">${expiringItems.length} item(s)</span> that will expire in the next 30 days:</p><ul class="mt-2 ml-5 list-disc">`;
            
            expiringItems.forEach(item => {
                const expiryDate = new Date(item.expiryDate);
                const daysUntilExpiry = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
                response += `<li class="mb-2"><span class="font-semibold">${item.name}</span> - Expires on ${expiryDate.toLocaleDateString()} (in ${daysUntilExpiry} days). Quantity: ${item.quantity}</li>`;
            });
            
            response += `</ul><p class="mt-3 text-gray-800">I recommend using these items first or considering if they can be redistributed to prevent waste. You might also consider offering them at a discount to increase usage before expiration.</p>`;
            
            return response;
        }

        function analyzeDepartmentUsage(transactions, inventory) {
            const departmentUsage = {};
            const departments = JSON.parse(localStorage.getItem('departments') || '[]');
            
            // Initialize department usage
            departments.forEach(dept => {
                departmentUsage[dept] = { count: 0, value: 0 };
            });
            
            // Calculate usage
            transactions.forEach(transaction => {
                if (transaction.type === 'issue') {
                    const item = inventory.find(i => i.id === transaction.itemId);
                    if (item) {
                        departmentUsage[transaction.department].count += transaction.quantity;
                        departmentUsage[transaction.department].value += item.price * transaction.quantity;
                    }
                }
            });
            
            // Find the department with the highest usage
            let topDepartment = null;
            let maxValue = 0;
            
            for (const dept in departmentUsage) {
                if (departmentUsage[dept].value > maxValue) {
                    maxValue = departmentUsage[dept].value;
                    topDepartment = dept;
                }
            }
            
            if (!topDepartment) {
                return "<p class='text-gray-800'>I don't have enough data yet to analyze department usage. More transaction history is needed.</p>";
            }
            
            // Create department usage table
            let table = `<div class="overflow-x-auto mt-4"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items Used</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value (Ksh)</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            
            for (const dept in departmentUsage) {
                if (departmentUsage[dept].count > 0) {
                    table += `<tr><td class="px-4 py-2 whitespace-nowrap">${dept}</td><td class="px-4 py-2 whitespace-nowrap">${departmentUsage[dept].count}</td><td class="px-4 py-2 whitespace-nowrap">${departmentUsage[dept].value.toLocaleString()}</td></tr>`;
                }
            }
            
            table += `</tbody></table></div>`;
            
            return `<p class="text-gray-800 mb-3">Based on transaction history, the <span class="font-semibold">${topDepartment}</span> department uses the most supplies, with a total value of Ksh${maxValue.toLocaleString()} issued to them.</p>${table}`;
        }

        function analyzeInventoryValue(inventory) {
            const totalValue = inventory.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const mostValuable = inventory.reduce((max, item) => {
                const value = item.price * item.quantity;
                return value > max.value ? { item: item.name, value: value } : max;
            }, { item: '', value: 0 });
            
            const averageValue = totalValue / inventory.length;
            
            return `<p class="text-gray-800">The total value of your inventory is <span class="font-semibold">Ksh${totalValue.toLocaleString()}</span>.</p>
                    <p class="text-gray-800 mt-2">The most valuable item in stock is <span class="font-semibold">${mostValuable.item}</span> with a total value of Ksh${mostValuable.value.toLocaleString()}.</p>
                    <p class="text-gray-800 mt-2">The average item value is Ksh${averageValue.toLocaleString(undefined, { maximumFractionDigits: 2 })}.</p>`;
        }

        function analyzeCategories(inventory) {
            const categories = {};
            
            inventory.forEach(item => {
                if (!categories[item.category]) {
                    categories[item.category] = { count: 0, value: 0 };
                }
                categories[item.category].count += item.quantity;
                categories[item.category].value += item.price * item.quantity;
            });
            
            let response = `<p class="text-gray-800 mb-3">Your inventory contains items from the following categories:</p><ul class="mt-2 ml-5 list-disc">`;
            
            for (const category in categories) {
                response += `<li class="mb-2"><span class="font-semibold">${category}</span> - ${categories[category].count} items (Ksh${categories[category].value.toLocaleString()})</li>`;
            }
            
            response += "</ul>";
            
            return response;
        }

        function analyzeForecast(inventory) {
            const lowUsageItems = [];
            const criticalItems = [];
            
            inventory.forEach(item => {
                if (item.dailyUsage > 0) {
                    const daysUntilOut = Math.floor(item.quantity / item.dailyUsage);
                    
                    if (daysUntilOut < 30) {
                        criticalItems.push({ name: item.name, days: daysUntilOut, usage: item.dailyUsage });
                    } else if (daysUntilOut < 60) {
                        lowUsageItems.push({ name: item.name, days: daysUntilOut, usage: item.dailyUsage });
                    }
                }
            });
            
            if (criticalItems.length === 0 && lowUsageItems.length === 0) {
                return "<p class='text-green-600 font-medium'>Based on current usage rates, all items are well stocked for at least the next 60 days. No urgent reordering needed at this time.</p>";
            }
            
            let response = "<p class='text-gray-800 mb-3'>Based on current usage patterns:</p><ul class='mt-2 ml-5 list-disc'>";
            
            if (criticalItems.length > 0) {
                response += "<li class='mb-2'><span class='font-semibold text-red-600'>Critical items (will run out within 30 days):</span><ul class='ml-5 mt-1 list-circle'>";
                criticalItems.forEach(item => {
                    response += `<li>${item.name} - will run out in ${item.days} days (usage: ${item.usage}/day)</li>`;
                });
                response += "</ul></li>";
            }
            
            if (lowUsageItems.length > 0) {
                response += "<li class='mb-2'><span class='font-semibold text-yellow-600'>Items to monitor (will run out in 30-60 days):</span><ul class='ml-5 mt-1 list-circle'>";
                lowUsageItems.forEach(item => {
                    response += `<li>${item.name} - will run out in ${item.days} days (usage: ${item.usage}/day)</li>`;
                });
                response += "</ul></li>";
            }
            
            response += "</ul><p class='mt-3 text-gray-800'>I recommend planning your orders accordingly to avoid stockouts. Consider ordering at least 2-3 weeks before the predicted stockout date to account for delivery times.</p>";
            
            return response;
        }

        function generateInventoryReport(inventory, transactions) {
            const totalValue = inventory.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const lowStockCount = inventory.filter(item => item.quantity <= item.reorderLevel).length;
            
            // Find categories
            const categories = [...new Set(inventory.map(item => item.category))];
            
            // Calculate sustainability score
            const issuedItems = transactions.filter(t => t.type === 'issue').reduce((sum, t) => sum + t.quantity, 0);
            const expiredItems = inventory.filter(item => {
                if (!item.expiryDate) return false;
                const expiryDate = new Date(item.expiryDate);
                return expiryDate < new Date() && item.quantity > 0;
            }).reduce((sum, item) => sum + item.quantity, 0);
            
            const sustainability = issuedItems + expiredItems > 0 ? 
                (issuedItems / (issuedItems + expiredItems)) * 100 : 100;
                
            return `<div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h3 class="text-lg font-semibold text-blue-800 mb-2">Inventory Health Report</h3>
                        <p class="text-blue-700">Generated on ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <p class="text-sm text-gray-500">Total Inventory Value</p>
                            <p class="text-xl font-semibold">Ksh${totalValue.toLocaleString()}</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <p class="text-sm text-gray-500">Items Requiring Reorder</p>
                            <p class="text-xl font-semibold">${lowStockCount}</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <p class="text-sm text-gray-500">Categories</p>
                            <p class="text-xl font-semibold">${categories.length}</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <p class="text-sm text-gray-500">Sustainability Score</p>
                            <p class="text-xl font-semibold">${sustainability.toFixed(0)}%</p>
                        </div>
                    </div>
                    
                    <p class="text-gray-800 mt-4">Your inventory is in <span class="font-semibold">${sustainability > 80 ? 'excellent' : sustainability > 60 ? 'good' : 'needs improvement'}</span> condition. ${sustainability > 80 ? 'Keep up the good work managing your stock levels!' : 'Consider reviewing your ordering patterns to reduce waste.'}</p>`;
        }

        function provideInventoryOverview(inventory) {
            const totalItems = inventory.reduce((sum, item) => sum + item.quantity, 0);
            const totalValue = inventory.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const lowStockCount = inventory.filter(item => item.quantity <= item.reorderLevel).length;
            
            // Find categories
            const categories = [...new Set(inventory.map(item => item.category))];
            
            return `<p class="text-gray-800">Your inventory currently has <span class="font-semibold">${totalItems} items</span> with a total value of <span class="font-semibold">Ksh${totalValue.toLocaleString()}</span>.</p>
                    <p class="text-gray-800 mt-2"><span class="font-semibold">${lowStockCount} items</span> are currently low in stock and may need reordering.</p>
                    <p class="text-gray-800 mt-2">Your inventory spans <span class="font-semibold">${categories.length} categories</span>: ${categories.join(', ')}.</p>
                    <p class="text-gray-800 mt-2">For more specific information, ask about low stock, expiring items, or department usage.</p>`;
        }
    </script>
</body>
</html>